
#!/bin/bash
set -e
yum update -y
amazon-linux-extras enable python3.8
yum install -y python3-pip git

mkdir -p /opt/app && cd /opt/app
git clone https://github.com/Arvo-AI/hello_world.git /opt/app-src
cp -r /opt/app-src/app/* /opt/app/

pip3 install --upgrade pip
[ -f requirements.txt ] && pip3 install -r requirements.txt
pip3 install gunicorn

PUB_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 || echo "127.0.0.1")
grep -rl "localhost" /opt/app | xargs -r sed -i "s#http://localhost:5000#http://${PUB_IP}#g"

cat >/etc/systemd/system/app.service <<EOF
[Unit]
Description=Autodeploy App
After=network.target
[Service]
WorkingDirectory=/opt/app
ExecStart={{ start_cmd }}
Restart=always
Environment=PYTHONUNBUFFERED=1
[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload && systemctl enable app && systemctl start app
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 5000
